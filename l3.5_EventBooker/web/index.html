<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Event Booker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h2 { margin-top: 40px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        input, button { margin: 5px 0; padding: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Event Booker</h1>

    <label>
        <input type="radio" name="role" value="user" checked> User
    </label>
    <label>
        <input type="radio" name="role" value="admin"> Admin
    </label>

    <div id="admin-section" class="hidden">
        <h2>Create Event</h2>
        <form id="create-event-form">
            <input type="text" id="event-name" placeholder="Event Name" required><br>
            <input type="datetime-local" id="event-date" required><br>
            <input type="number" id="event-capacity" placeholder="Capacity" min="1" required><br>
            <input type="number" id="payment-ttl" placeholder="Payment TTL (minutes)" min="1" required><br>
            <button type="submit">Create Event</button>
        </form>
    </div>

    <h2>Events</h2>
    <table id="events-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Date</th>
                <th>Capacity</th>
                <th>Free Seats</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const apiBase = '';
        let role = 'user';

        document.querySelectorAll('input[name="role"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                role = e.target.value;
                document.getElementById('admin-section').classList.toggle('hidden', role !== 'admin');
                loadEvents();
            });
        });

        async function loadEvents() {
            const res = await fetch(`${apiBase}/events`);
            const events = await res.json();
            const tbody = document.querySelector('#events-table tbody');
            tbody.innerHTML = '';
            events.forEach(event => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${event.id}</td>
                    <td>${event.name}</td>
                    <td>${new Date(event.date).toLocaleString()}</td>
                    <td>${event.capacity}</td>
                    <td>${event.free_seats}</td>
                    <td>
                        ${role === 'user' ? `<button onclick="bookEvent(${event.id})">Book</button>` : ''}
                        ${role === 'admin' ? `<button onclick="confirmBookings(${event.id})">Confirm Bookings</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('create-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('event-name').value;
            const date = document.getElementById('event-date').value;
            const capacity = parseInt(document.getElementById('event-capacity').value);
            const paymentTTL = parseInt(document.getElementById('payment-ttl').value) * 60 * 1000;

            const res = await fetch(`${apiBase}/events`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, date, capacity, payment_ttl: paymentTTL })
            });

            if (res.ok) {
                alert('Event created!');
                loadEvents();
            } else {
                alert('Failed to create event');
            }
        });

        async function bookEvent(eventID) {
            const seats = parseInt(prompt('How many seats?'));
            if (!seats || seats < 1) return;
            const res = await fetch(`${apiBase}/events/${eventID}/book`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seats })
            });
            if (res.ok) {
                alert('Booking created! Confirm before TTL expires.');
                loadEvents();
            } else {
                const err = await res.json();
                alert('Failed to book: ' + err.error);
            }
        }

        async function confirmBookings(eventID) {
            const res = await fetch(`${apiBase}/events/${eventID}`);
            const event = await res.json();
            if (!event) return;

            alert('This button should confirm bookings individually via API');
        }

        setInterval(loadEvents, 10000);

        loadEvents();
    </script>
</body>
</html>
